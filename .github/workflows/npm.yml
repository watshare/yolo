name: NPM Dependency Downloader

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js版本'
        required: true
        default: '18.x'
      npm_version:
        description: 'npm版本'
        required: true
        default: '9.x'
      package_specs:
        description: '要下载的插件和版本，格式为"插件名@版本号"，多个插件使用逗号分隔（例如：react@18.2.0,express@4.18.2,lodash）'
        required: true

jobs:
  download-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
      
      - name: 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: ${{ github.event.inputs.node_version }}
      
      - name: 安装指定版本的npm
        run: npm install -g npm@${{ github.event.inputs.npm_version }}
      
      - name: 创建临时目录
        run: mkdir -p ./npm-packages && mkdir -p ./package-tarballs
      
      - name: 准备package.json
        working-directory: ./npm-packages
        run: |
          # 初始化package.json
          npm init -y
          
          # 清空package.json中的dependencies字段
          echo '{
            "name": "npm-packages",
            "version": "1.0.0",
            "description": "",
            "main": "index.js",
            "scripts": {
              "test": "echo \"Error: no test specified\" && exit 1"
            },
            "keywords": [],
            "author": "",
            "license": "ISC",
            "dependencies": {}
          }' > package.json
          
          # 将输入的包规范添加到package.json
          IFS=',' read -ra PACKAGE_SPECS <<< "${{ github.event.inputs.package_specs }}"
          
          # 构建依赖对象
          DEPS='{'
          first=true
          for spec in "${PACKAGE_SPECS[@]}"; do
            spec=$(echo "$spec" | xargs)
            if [[ -z "$spec" ]]; then
              continue
            fi
            
            # 添加逗号分隔符
            if [ "$first" = false ]; then
              DEPS+=", "
            else
              first=false
            fi
            
            # 提取包名和版本
            if [[ "$spec" == *@* ]]; then
              package="${spec%@*}"
              version="${spec#*@}"
            else
              package="$spec"
              version="latest"
            fi
            
            # 添加到依赖对象
            DEPS+="\"$package\": \"$version\""
          done
          DEPS+='}'
          
          # 更新package.json中的dependencies字段
          jq --argjson deps "$DEPS" '.dependencies = $deps' package.json > package.tmp.json
          mv package.tmp.json package.json
          
          echo "生成的package.json内容:"
          cat package.json
      
      - name: 生成package-lock.json
        working-directory: ./npm-packages
        run: |
          # 安装依赖并强制生成package-lock.json
          npm install --ignore-scripts --no-audit --no-fund --package-lock-only
          
          # 验证package-lock.json是否存在
          if [ ! -f "package-lock.json" ]; then
            echo "错误: package-lock.json未生成!"
            # 显示目录内容用于调试
            echo "当前目录内容:"
            ls -la
            exit 1
          fi
          
          echo "package-lock.json生成成功!"
          # 显示package-lock.json的内容摘要
          echo "package-lock.json内容摘要:"
          head -n 20 package-lock.json
          echo "..."
          tail -n 20 package-lock.json
      
      - name: 下载所有依赖的原始包
        working-directory: ./npm-packages
        run: |
          # 检查license-checker是否安装
          if ! command -v license-checker &> /dev/null
          then
            echo "安装license-checker工具..."
            npm install -g license-checker
          fi
          
          # 下载所有依赖包
          npm pack $(npx -y license-checker --json --onlyDependencies --production | jq -r 'to_entries[] | "\(.key)@\(.value.version)"') --pack-destination ../package-tarballs
          
          # 验证是否下载了包
          if [ -z "$(ls -A ../package-tarballs)" ]; then
            echo "错误: 没有下载任何包!"
            exit 1
          fi
      
      - name: 创建打包文件
        run: |
          tar -czvf npm-packages.tar.gz ./package-tarballs
          echo "ARCHIVE_FILE=npm-packages.tar.gz" >> $GITHUB_ENV
      
      - name: 上传打包文件作为工件
        uses: actions/upload-artifact@v4
        with:
          name: npm-packages
          path: ${{ env.ARCHIVE_FILE }}
          retention-days: 7    
